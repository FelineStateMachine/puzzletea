name: VHS GIFs

on:
  release:
    types: [published]
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "vhs/*.tape"

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-gifs:
    name: Generate GIFs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build binary
        run: go build -ldflags "-X main.version=${{ github.ref_name }}" -o puzzletea

      - name: Install VHS and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg ttyd
          go install github.com/charmbracelet/vhs@latest

      - name: Generate GIFs
        run: |
          vhs vhs/menu.tape
          vhs vhs/nonogram.tape
          vhs vhs/sudoku.tape
          vhs vhs/wordsearch.tape
          vhs vhs/hashiwokakero.tape
          vhs vhs/lightsout.tape

      - name: Create PR with updated GIFs
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add vhs/*.gif
          if git diff --cached --quiet; then
            echo "No GIF changes to commit"
            exit 0
          fi
          branch="chore/regenerate-vhs-gifs"
          git checkout -b "$branch"
          git commit -m "chore: regenerate VHS GIFs"
          git push --force origin "$branch"
          if gh pr list --head "$branch" --state open --json number --jq '.[0].number' | grep -q .; then
            echo "PR already exists"
          else
            gh pr create \
              --title "chore: regenerate VHS GIFs" \
              --body "Auto-generated by the VHS workflow. Merge to update game preview GIFs." \
              --head "$branch" \
              --base main
          fi
        env:
          GH_TOKEN: ${{ github.token }}
